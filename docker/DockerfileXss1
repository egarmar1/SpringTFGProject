FROM ubuntu:20.04

# Prevenir solicitudes interactivas durante la instalación de paquetes
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=Etc/UTC
ENV USER=root

# Agregar el repositorio de Adoptium y su clave GPG, luego instalar OpenJDK 21
RUN apt-get update && \
    apt-get install -y wget apt-transport-https gnupg && \
    wget -O - https://packages.adoptium.net/artifactory/api/gpg/key/public | apt-key add - && \
    echo "deb https://packages.adoptium.net/artifactory/deb bionic main" | tee /etc/apt/sources.list.d/adoptium.list && \
    apt-get update && \
    apt-get install -y temurin-21-jdk

# Instalar VNC, XFCE y otras herramientas necesarias
RUN apt-get install -y xfce4 xfce4-goodies tightvncserver curl git

# Instalar el emulador de terminal xfce4-terminal
RUN apt-get install -y xfce4-terminal

# Instalar aplicaciones adicionales (ejemplo: Firefox y Gedit)
RUN apt-get update && \
    apt-get install -y --fix-missing firefox gedit

# Instalar Python y las dependencias de Selenium
RUN apt-get install -y python3 python3-pip && \
    pip3 install selenium webdriver-manager

# Configurar VNC
RUN mkdir -p /root/.vnc

# Crear script para iniciar VNC con XFCE
RUN echo '#!/bin/bash\n\
    xrdb $HOME/.Xresources\n\
    startxfce4 &' > /root/.vnc/xstartup && \
    chmod +x /root/.vnc/xstartup

# Instalar Google Chrome y sus dependencias
RUN wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | apt-key add - && \
    echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" > /etc/apt/sources.list.d/google-chrome.list && \
    apt-get update && \
    apt-get install -y google-chrome-stable fonts-liberation libappindicator3-1 xdg-utils

RUN apt -f install -y
RUN apt-get install -y wget
RUN wget -q https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
RUN apt-get install ./google-chrome-stable_current_amd64.deb -y


RUN wget -qO - https://download.sublimetext.com/sublimehq-pub.gpg | apt-key add - && \
    apt-get install apt-transport-https && \
    echo "deb https://download.sublimetext.com/ apt/stable/" | tee /etc/apt/sources.list.d/sublime-text.list && \
    apt-get update && \
    apt-get install -y sublime-text


COPY autoLoginAdmin.py /root/app/autoLoginAdmin.py
COPY server.py /root/app/server.py
COPY solution.js /root/app/solution.js

# Copiar la aplicación Spring Boot al contenedor
COPY xss1-0.0.1-SNAPSHOT.jar /root/app/xss1-0.0.1-SNAPSHOT.jar

# Exponer el puerto VNC y el puerto de la aplicación Spring Boot
EXPOSE 5901
EXPOSE 8082

# Configurar VNC y lanzar aplicaciones en el contenedor
CMD ["sh", "-c", "echo $VNC_PASSWORD | vncpasswd -f > /root/.vnc/passwd && chmod 600 /root/.vnc/passwd && USER=root vncserver :1 -geometry 1280x800 -depth 24 && java -jar /root/app/xss1-0.0.1-SNAPSHOT.jar && tail -F /root/.vnc/*.log"]

# Iniciar Sublime Text al iniciar VNC
RUN echo 'sublime-text &' >> /root/.vnc/xstartup